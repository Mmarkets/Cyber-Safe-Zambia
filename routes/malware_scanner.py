from flask import Blueprint, render_template, flash
from flask_login import login_required
from flask_wtf import FlaskForm
from wtforms import FileField, SubmitField, StringField
from wtforms.validators import DataRequired, Email, Optional
from controllers.malware_controller import scan_file
from controllers.email_controller import send_alert_email

malware_scanner_bp = Blueprint('malware_scanner', __name__)

class MalwareForm(FlaskForm):
    file = FileField('Upload File', validators=[DataRequired()])
    email = StringField('Email for Alerts (Optional)', validators=[Email(), Optional()])
    submit = SubmitField('Scan File')

@malware_scanner_bp.route('/malware-scanner', methods=['GET', 'POST'])
@login_required
def malware_scanner():
    form = MalwareForm()
    result = None
    if form.validate_on_submit():
        result = scan_file(form.file.data)
        flash(result['status'], result['category'])
        if result['status'] == 'Malware Detected' and form.email.data:
            subject = "Cyber Safe Zambia: Malware Detected"
            body = "A file you uploaded was flagged as containing malware. Please delete it and scan your device."
            send_alert_email(form.email.data, subject, body)
    return render_template('malware_scanner.html', form=form, result=result)